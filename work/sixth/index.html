<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../../common/css/reset.css">
  <link rel="stylesheet" href="../../common/css/base.css">
  <link rel="stylesheet" href="./css/style.css">
  <title>Document</title>
</head>

<body>
  <div class="wrapper" id="wrapper">
    <button type="button" class="btn search-btn" id="pokemon_search">ポケモンを探す</button>
  </div>
  <script src="../../common/js/jquery.js"></script>
  <script>
    // 回答はここに書いてね
    $(function () {
      const pokeBall = 'https://pokeapi.co/api/v2/item/4'

      function randomPokeNumber() {
        return Math.round(Math.random() * (151 - 1) + 1);
      }

      function generateEncountHtml(res, japanese) {
        return `
                <p class="name">${japanese.names[0].name}</p>
                <div>
                  <img class="img" src="${res.sprites.front_default}" alt="">
                </div>
                <div>
                  <button class="btn" id="catch">捕まえる</button>
                  <button class="btn" data-js="reset">逃げる</button>
                </div>
              `
      }

      function collectJudge() {
        return Math.round(Math.random() * (2 - 1) + 1);
      }

      function generateDoneHtml(res) {
        return `
                <p class="name">ゲットしました</p>
                <div>
                  <img class="img" src="${res.sprites.default}" alt="">
                </div>
                <button class="btn" data-js="reset">戻る</button>
              `
      }

      function generateFailHtml() {
        return `
                 <p class="text">逃げられてしまった...</p>
                 <button class="btn mt" data-js="reset">戻る</button>
               `
      }

      function reset() {
        return $('#wrapper').html('<button type="button" class="btn search-btn" id="pokemon_search">ポケモンを探す</button>');
      }

      //「ポケモンを探す」ボタン押下
      $('#wrapper').on('click', '#pokemon_search', function () {
        let pokeUrl = 'https://pokeapi.co/api/v2/pokemon/' + randomPokeNumber();

        $.ajax({
          url: pokeUrl,
          method: 'GET'
        }).done(function (res) {
          $.ajax({
            url: res.species.url,
            method: 'GET'
          }).done(function (japanese) {
            console.log(japanese);
            let encountHtml = generateEncountHtml(res, japanese)
            $('#wrapper').html(encountHtml)
          })
        })
      })

      //「戻る」「逃げる」ボタン押下
      $('#wrapper').on('click', '.btn[data-js="reset"]', reset);

      //「捕まえる」ボタン押下
      $('#wrapper').on('click', '#catch', function () {
        console.log(collectJudge());
        if (collectJudge() === 1) {
          //捕獲成功時
          $.ajax({
            url: pokeBall,
            method: 'GET'
          }).done(function (res) {
            let doneHtml = generateDoneHtml(res);
            $('#wrapper').html(doneHtml);
          })
        } else {
          //捕獲失敗時
          let failHtml = generateFailHtml();
          $('#wrapper').html(failHtml);
        };
      })
    });
  </script>
</body>

</html>